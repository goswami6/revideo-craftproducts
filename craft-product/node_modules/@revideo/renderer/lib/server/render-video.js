"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.renderPartialVideo = exports.renderVideo = void 0;
const ffmpeg_1 = require("@revideo/ffmpeg");
const vite_plugin_1 = require("@revideo/vite-plugin");
const fs = require("fs");
const os = require("os");
const path = require("path");
const puppeteer_1 = require("puppeteer");
const uuid_1 = require("uuid");
const vite_1 = require("vite");
const renderer_plugin_1 = require("./renderer-plugin");
/**
 * We pass a lot of render settings to the client side of the renderer
 * via the URL. This function builds the URL with the necessary parameters.
 */
function buildUrl(port, fileName, workerId, totalNumOfWorkers, range = [0, Infinity], hiddenFolderId, dimensions) {
    const fileNameEscaped = encodeURIComponent(fileName);
    const hiddenFolderIdEscaped = encodeURIComponent(hiddenFolderId);
    const dimensionsString = dimensions
        ? `&videoWidth=${dimensions[0]}&videoHeight=${dimensions[1]}`
        : '';
    return (`http://localhost:${port}/render?fileName=${fileNameEscaped}&workerId=${workerId}&totalNumOfWorkers=${totalNumOfWorkers}&startInSeconds=${range[0]}&endInSeconds=${range[1]}&hiddenFolderId=${hiddenFolderIdEscaped}` +
        dimensionsString);
}
/**
 * Starts the vite server and creates a puppeteer browser instance
 */
async function initBrowserAndServer(fixedPort, projectFile, outputFolderName, settings, variables) {
    const args = settings.puppeteer?.args ?? [];
    args.includes('--single-process') || args.push('--single-process');
    const resolvedProjectPath = path.join(process.cwd(), projectFile);
    const [browser, server] = await Promise.all([
        puppeteer_1.default.launch({ headless: true, ...settings.puppeteer, args }),
        (0, vite_1.createServer)({
            configFile: false,
            server: {
                ...settings.viteServerOptions,
                port: fixedPort,
                hmr: false,
            },
            plugins: [
                (0, vite_plugin_1.default)({ project: resolvedProjectPath, output: outputFolderName }),
                (0, renderer_plugin_1.rendererPlugin)(variables, settings.ffmpeg, projectFile),
            ],
        }).then(server => server.listen()),
    ]);
    if (!server.httpServer) {
        throw new Error('HTTP server is not initialized');
    }
    const address = server.httpServer.address();
    const resolvedPort = address && typeof address === 'object' ? address.port : null;
    if (resolvedPort === null) {
        throw new Error('Server address is null');
    }
    return { browser, server, resolvedPort };
}
function trackProgress(tracker, id, progress) {
    tracker.set(id, progress);
}
/**
 * Navigates to the URL and renders the video on the page
 */
async function renderVideoOnPage(id, browser, server, url, progressTracker, progressCallback, logProgress) {
    function printProgress() {
        let line = '';
        for (const [key, value] of progressTracker.entries()) {
            line += `Render progress, worker ${key}: ${(value * 100).toFixed(0)}% `;
        }
        if (line === '') {
            return;
        }
        console.log(line);
    }
    const interval = setInterval(() => {
        printProgress();
    }, 1000);
    const page = await browser.newPage();
    if (!server.httpServer) {
        throw new Error('HTTP server is not initialized');
    }
    const address = server.httpServer.address();
    const port = address && typeof address === 'object' ? address.port : null;
    if (port === null) {
        throw new Error('Server address is null');
    }
    // Attach logs from puppeteer to the console
    page.on('console', msg => {
        for (let i = 0; i < msg.args().length; ++i) {
            const message = msg.args()[i];
            if (message.toString().includes('[vite]')) {
                continue;
            }
            console.log(`Worker ${id}: ${msg.args()[i]}`);
        }
    });
    page.exposeFunction('logProgress', (progress) => {
        if (progressCallback) {
            progressCallback(id, progress);
        }
        if (logProgress) {
            trackProgress(progressTracker, id, progress);
        }
    });
    const renderingComplete = new Promise((resolve, reject) => {
        page.exposeFunction('onRenderComplete', async () => {
            await Promise.all([browser.close(), server.close()]);
            clearInterval(interval);
            resolve();
        });
        page.exposeFunction('onRenderFailed', async (errorMessage) => {
            await Promise.all([browser.close(), server.close()]);
            console.error('Rendering failed:', errorMessage);
            clearInterval(interval);
            reject(new Error(errorMessage));
        });
    });
    await page.goto(url);
    return renderingComplete;
}
/**
 * Initializes the browser and starts rendering the video
 */
async function initializeBrowserAndStartRendering(projectFile, outputFileName, outputFolderName, i, numOfWorkers, settings, hiddenFolderId, variables, progressCallback) {
    const port = (settings.viteBasePort !== undefined ? settings.viteBasePort : 9000) + i;
    const progressTracker = new Map();
    const { browser, server, resolvedPort } = await initBrowserAndServer(port, projectFile, outputFolderName, settings, variables);
    const url = buildUrl(resolvedPort, `${outputFileName}-${i}`, i, numOfWorkers, settings.range, hiddenFolderId, settings.dimensions);
    return renderVideoOnPage(i, browser, server, url, progressTracker, progressCallback, settings.logProgress);
}
/**
 * Collects audio and video files from each worker and returns them.
 * If audio file does not exist, creates a silent audio file with the same duration as the video file.
 */
async function collectAudioAndVideoFiles(numOfWorkers, outputFileName, hiddenFolderId) {
    const audioFiles = [];
    const videoFiles = [];
    for (let i = 0; i < numOfWorkers; i++) {
        const videoFilePath = `${os.tmpdir()}/revideo-${outputFileName}-${i}-${hiddenFolderId}/visuals.mp4`;
        const audioFilePath = `${os.tmpdir()}/revideo-${outputFileName}-${i}-${hiddenFolderId}/audio.wav`;
        if (!(await (0, ffmpeg_1.doesFileExist)(audioFilePath))) {
            const videoDuration = await (0, ffmpeg_1.getVideoDuration)(videoFilePath);
            await (0, ffmpeg_1.createSilentAudioFile)(audioFilePath, videoDuration);
        }
        videoFiles.push(videoFilePath);
        audioFiles.push(audioFilePath);
    }
    return { audioFiles, videoFiles };
}
/**
 * Concatenates audio and video files and merges them into a single video file.
 */
async function concatenateAudioAndVideoFiles(outputFileName, outputFolder, audioFiles, videoFiles) {
    await (0, ffmpeg_1.concatenateMedia)(videoFiles, path.join(outputFolder, `${outputFileName}-visuals.mp4`));
    await (0, ffmpeg_1.concatenateMedia)(audioFiles, path.join(outputFolder, `${outputFileName}-audio.wav`));
    await (0, ffmpeg_1.mergeAudioWithVideo)(path.join(outputFolder, `${outputFileName}-audio.wav`), path.join(outputFolder, `${outputFileName}-visuals.mp4`), path.join(outputFolder, `${outputFileName}.mp4`));
}
/**
 * Deletes all partial files after concatenation is done
 */
async function cleanup(outputFileName, outputFolderName, numOfWorkers, hiddenFolderId) {
    const cleanupFolders = [];
    const cleanupFiles = [];
    for (let i = 0; i < numOfWorkers; i++) {
        cleanupFolders.push(`${os.tmpdir()}/revideo-${outputFileName}-${i}-${hiddenFolderId}`);
        cleanupFiles.push(path.join(process.cwd(), outputFolderName, `${outputFileName}-${i}.mp4`));
    }
    cleanupFiles.push(path.join(process.cwd(), outputFolderName, `${outputFileName}-audio.wav`));
    cleanupFiles.push(path.join(process.cwd(), outputFolderName, `${outputFileName}-visuals.mp4`));
    const folderCleanupPromises = cleanupFolders.map(folder => fs.promises.rm(folder, { recursive: true, force: true }).catch(() => { }));
    const fileCleanupPromises = cleanupFiles.map(file => fs.promises.unlink(file).catch(() => { }));
    await Promise.all([...folderCleanupPromises, ...fileCleanupPromises]);
}
function getPropDefaults(settings) {
    if (settings.outFile && !settings.outFile.endsWith('.mp4')) {
        throw new Error('outFile must end with ".mp4"');
    }
    const outFile = settings.outFile?.slice(0, -4) ?? 'video';
    return {
        outputFileName: outFile,
        outputFolderName: settings.outDir ?? './output',
        numOfWorkers: settings.workers ?? 1,
        hiddenFolderId: (0, uuid_1.v4)(),
    };
}
/**
 * Renders a video to a file.
 * @param projectFile - Path to the project.ts file.
 * @param variables - Variables to pass to your project (see https://docs.re.video/parameterized-video)
 * @param progressCallback - Callback function to track rendering progress. Progress is a number between 0 and 1.
 * @param settings - Settings for the rendering process.
 * @returns - Path to the rendered video file.
 */
const renderVideo = async ({ projectFile, variables, settings = {}, }) => {
    const { outputFileName, outputFolderName, numOfWorkers, hiddenFolderId } = getPropDefaults(settings);
    // Start rendering
    const renderPromises = [];
    for (let i = 0; i < numOfWorkers; i++) {
        renderPromises.push(initializeBrowserAndStartRendering(projectFile, outputFileName, outputFolderName, i, numOfWorkers, settings, hiddenFolderId, variables, settings.progressCallback));
    }
    // Wait for workers to finish rendering
    await Promise.all(renderPromises);
    // Collect and concatenate audio and video files
    const { audioFiles, videoFiles } = await collectAudioAndVideoFiles(numOfWorkers, outputFileName, hiddenFolderId);
    await concatenateAudioAndVideoFiles(outputFileName, outputFolderName, audioFiles, videoFiles);
    await cleanup(outputFileName, outputFolderName, numOfWorkers, hiddenFolderId);
    return path.join(outputFolderName, `${outputFileName}.mp4`);
};
exports.renderVideo = renderVideo;
const renderPartialVideo = async ({ projectFile, variables, settings, numWorkers, workerId, }) => {
    const { outputFileName, outputFolderName, hiddenFolderId } = getPropDefaults(settings);
    await initializeBrowserAndStartRendering(projectFile, outputFileName, outputFolderName, workerId, numWorkers, settings, hiddenFolderId, variables, settings.progressCallback);
    const videoFilePath = `${os.tmpdir()}/revideo-${outputFileName}-${workerId}-${hiddenFolderId}/visuals.mp4`;
    const audioFilePath = `${os.tmpdir()}/revideo-${outputFileName}-${workerId}-${hiddenFolderId}/audio.wav`;
    if (!(await (0, ffmpeg_1.doesFileExist)(audioFilePath))) {
        const videoDuration = await (0, ffmpeg_1.getVideoDuration)(videoFilePath);
        await (0, ffmpeg_1.createSilentAudioFile)(audioFilePath, videoDuration);
    }
    return { audioFile: audioFilePath, videoFile: videoFilePath };
};
exports.renderPartialVideo = renderPartialVideo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyLXZpZGVvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc2VydmVyL3JlbmRlci12aWRlby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw0Q0FPeUI7QUFDekIsc0RBQWdEO0FBQ2hELHlCQUF5QjtBQUN6Qix5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLHlDQUEyRTtBQUMzRSwrQkFBa0M7QUFDbEMsK0JBQWdFO0FBQ2hFLHVEQUFpRDtBQUVqRDs7O0dBR0c7QUFDSCxTQUFTLFFBQVEsQ0FDZixJQUFZLEVBQ1osUUFBZ0IsRUFDaEIsUUFBZ0IsRUFDaEIsaUJBQXlCLEVBQ3pCLFFBQTBCLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxFQUN2QyxjQUFzQixFQUN0QixVQUE2QjtJQUU3QixNQUFNLGVBQWUsR0FBRyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNyRCxNQUFNLHFCQUFxQixHQUFHLGtCQUFrQixDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ2pFLE1BQU0sZ0JBQWdCLEdBQUcsVUFBVTtRQUNqQyxDQUFDLENBQUMsZUFBZSxVQUFVLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDN0QsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUVQLE9BQU8sQ0FDTCxvQkFBb0IsSUFBSSxvQkFBb0IsZUFBZSxhQUFhLFFBQVEsc0JBQXNCLGlCQUFpQixtQkFBbUIsS0FBSyxDQUFDLENBQUMsQ0FBQyxpQkFBaUIsS0FBSyxDQUFDLENBQUMsQ0FBQyxtQkFBbUIscUJBQXFCLEVBQUU7UUFDck4sZ0JBQWdCLENBQ2pCLENBQUM7QUFDSixDQUFDO0FBZ0NEOztHQUVHO0FBQ0gsS0FBSyxVQUFVLG9CQUFvQixDQUNqQyxTQUFpQixFQUNqQixXQUFtQixFQUNuQixnQkFBd0IsRUFDeEIsUUFBd0IsRUFDeEIsU0FBbUM7SUFFbkMsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLFNBQVMs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