var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
import { createSignal, easeOutExpo, linear, map, threadable, } from '@revideo/core';
import { computed, initial, nodeName, signal } from '../decorators';
import { canvasStyleSignal, } from '../decorators/canvasStyleSignal';
import { resolveCanvasStyle } from '../utils';
import { Layout } from './Layout';
let Shape = class Shape extends Layout {
    rippleSize() {
        return easeOutExpo(this.rippleStrength(), 0, 50);
    }
    constructor(props) {
        super(props);
        this.rippleStrength = createSignal(0);
    }
    applyText(context) {
        context.direction = this.textDirection();
        this.element.dir = this.textDirection();
    }
    applyStyle(context) {
        context.fillStyle = resolveCanvasStyle(this.fill(), context);
        context.strokeStyle = resolveCanvasStyle(this.stroke(), context);
        context.lineWidth = this.lineWidth();
        context.lineJoin = this.lineJoin();
        context.lineCap = this.lineCap();
        context.setLineDash(this.lineDash());
        context.lineDashOffset = this.lineDashOffset();
        if (!this.antialiased()) {
            // from https://stackoverflow.com/a/68372384
            context.filter =
                'url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxmaWx0ZXIgaWQ9ImZpbHRlciIgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzPSJzUkdCIj48ZmVDb21wb25lbnRUcmFuc2Zlcj48ZmVGdW5jUiB0eXBlPSJpZGVudGl0eSIvPjxmZUZ1bmNHIHR5cGU9ImlkZW50aXR5Ii8+PGZlRnVuY0IgdHlwZT0iaWRlbnRpdHkiLz48ZmVGdW5jQSB0eXBlPSJkaXNjcmV0ZSIgdGFibGVWYWx1ZXM9IjAgMSIvPjwvZmVDb21wb25lbnRUcmFuc2Zlcj48L2ZpbHRlcj48L3N2Zz4=#filter)';
        }
    }
    async draw(context) {
        this.drawShape(context);
        if (this.clip()) {
            context.clip(this.getPath());
        }
        await this.drawChildren(context);
    }
    drawShape(context) {
        const path = this.getPath();
        const hasStroke = this.lineWidth() > 0 && this.stroke() !== null;
        const hasFill = this.fill() !== null;
        context.save();
        this.applyStyle(context);
        this.drawRipple(context);
        if (this.strokeFirst()) {
            hasStroke && context.stroke(path);
            hasFill && context.fill(path);
        }
        else {
            hasFill && context.fill(path);
            hasStroke && context.stroke(path);
        }
        context.restore();
    }
    getCacheBBox() {
        return super.getCacheBBox().expand(this.lineWidth() / 2);
    }
    getPath() {
        return new Path2D();
    }
    getRipplePath() {
        return new Path2D();
    }
    drawRipple(context) {
        const rippleStrength = this.rippleStrength();
        if (rippleStrength > 0) {
            const ripplePath = this.getRipplePath();
            context.save();
            context.globalAlpha *= map(0.54, 0, rippleStrength);
            context.fill(ripplePath);
            context.restore();
        }
    }
    *ripple(duration = 1) {
        this.rippleStrength(0);
        yield* this.rippleStrength(1, duration, linear);
        this.rippleStrength(0);
    }
};
__decorate([
    canvasStyleSignal()
], Shape.prototype, "fill", void 0);
__decorate([
    canvasStyleSignal()
], Shape.prototype, "stroke", void 0);
__decorate([
    initial(false),
    signal()
], Shape.prototype, "strokeFirst", void 0);
__decorate([
    initial(0),
    signal()
], Shape.prototype, "lineWidth", void 0);
__decorate([
    initial('miter'),
    signal()
], Shape.prototype, "lineJoin", void 0);
__decorate([
    initial('butt'),
    signal()
], Shape.prototype, "lineCap", void 0);
__decorate([
    initial([]),
    signal()
], Shape.prototype, "lineDash", void 0);
__decorate([
    initial(0),
    signal()
], Shape.prototype, "lineDashOffset", void 0);
__decorate([
    initial(true),
    signal()
], Shape.prototype, "antialiased", void 0);
__decorate([
    computed()
], Shape.prototype, "rippleSize", null);
__decorate([
    computed()
], Shape.prototype, "getPath", null);
__decorate([
    threadable()
], Shape.prototype, "ripple", null);
Shape = __decorate([
    nodeName('Shape')
], Shape);
export { Shape };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2hhcGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGliL2NvbXBvbmVudHMvU2hhcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsT0FBTyxFQUlMLFlBQVksRUFDWixXQUFXLEVBQ1gsTUFBTSxFQUNOLEdBQUcsRUFDSCxVQUFVLEdBQ1gsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNsRSxPQUFPLEVBRUwsaUJBQWlCLEdBQ2xCLE1BQU0saUNBQWlDLENBQUM7QUFFekMsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sVUFBVSxDQUFDO0FBQzVDLE9BQU8sRUFBQyxNQUFNLEVBQWMsTUFBTSxVQUFVLENBQUM7QUFldEMsSUFBZSxLQUFLLEdBQXBCLE1BQWUsS0FBTSxTQUFRLE1BQU07SUE4QjlCLFVBQVU7UUFDbEIsT0FBTyxXQUFXLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRUQsWUFBbUIsS0FBaUI7UUFDbEMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBUkksbUJBQWMsR0FBRyxZQUFZLENBQWUsQ0FBQyxDQUFDLENBQUM7SUFTbEUsQ0FBQztJQUVTLFNBQVMsQ0FBQyxPQUFpQztRQUNuRCxPQUFPLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN6QyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDMUMsQ0FBQztJQUVTLFVBQVUsQ0FBQyxPQUFpQztRQUNwRCxPQUFPLENBQUMsU0FBUyxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM3RCxPQUFPLENBQUMs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